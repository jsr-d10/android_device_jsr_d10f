From 82c8a8956c9f23878b1957a1333b266fd07dbd89 Mon Sep 17 00:00:00 2001
From: Gabriele M <moto.falcon.git@gmail.com>
Date: Thu, 3 Mar 2016 21:14:37 +0100
Subject: [PATCH 2/2] Allow to ignore presentation indicator of outgoing calls
 [3/3]

With some mobile network operators, the presentation indicator of
outgoing calls is always set to either "unknown" or "restricted".
As consequence, the dialed number doesn't show up in clear in the
call history. Allow to ignore the presentation indicator of outgoing
calls to never hide the dialed numbers.

Change-Id: I8848d6ac992e597584a0c04dcc925ed4e91c5a35
---
 AndroidManifest.xml                              |  1 +
 res/values/cm_strings.xml                        |  4 ++++
 res/xml/network_setting.xml                      |  5 +++++
 src/com/android/phone/MobileNetworkSettings.java | 19 +++++++++++++++++++
 4 files changed, 29 insertions(+)

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 1c37a0a1..dcef54b9 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -152,6 +152,7 @@
     <uses-permission android:name="android.permission.READ_BLOCKED_NUMBERS" />
     <!-- Needed for emergency contact notification. -->
     <uses-permission android:name="android.permission.WRITE_BLOCKED_NUMBERS" />
+    <uses-permission android:name="cyanogenmod.permission.WRITE_SETTINGS" />
 
     <!-- This tells the activity manager to not delay any of our activity
          start requests, even if they happen immediately after the user
diff --git a/res/values/cm_strings.xml b/res/values/cm_strings.xml
index bcfb6edc..fb97d6ab 100644
--- a/res/values/cm_strings.xml
+++ b/res/values/cm_strings.xml
@@ -85,4 +85,8 @@
     <string name="choose_network_mode_title">Choose network mode</string>
     <string name="choose_network_mode_system_default">System default</string>
     <string name="cdma_call_settings">CDMA call settings</string>
+
+    <!-- Mobile network settings, COLP -->
+    <string name="connected_line_identification_title">Connected line identification</string>
+    <string name="connected_line_identification_summary">Disable this option if the numbers of the recipients don\'t show up in the call history</string>
 </resources>
diff --git a/res/xml/network_setting.xml b/res/xml/network_setting.xml
index cdd9b89c..bf2a5b6b 100644
--- a/res/xml/network_setting.xml
+++ b/res/xml/network_setting.xml
@@ -50,4 +50,9 @@
         android:persistent="false"
         android:summary="@string/enhanced_4g_lte_mode_summary"/>
 
+    <SwitchPreference
+        android:key="connected_line_identification_key"
+        android:title="@string/connected_line_identification_title"
+        android:summary="@string/connected_line_identification_summary" />
+
 </PreferenceScreen>
diff --git a/src/com/android/phone/MobileNetworkSettings.java b/src/com/android/phone/MobileNetworkSettings.java
index 860c1355..a2678775 100644
--- a/src/com/android/phone/MobileNetworkSettings.java
+++ b/src/com/android/phone/MobileNetworkSettings.java
@@ -65,6 +65,8 @@ import android.widget.TabHost.TabContentFactory;
 import android.widget.TabHost.TabSpec;
 import android.widget.TabHost;
 
+import cyanogenmod.providers.CMSettings;
+
 /**
  * "Mobile network settings" screen.  This preference screen lets you
  * enable/disable mobile data, and control data roaming and other
@@ -101,6 +103,7 @@ public class MobileNetworkSettings extends PreferenceActivity
     private static final String BUTTON_OPERATOR_SELECTION_EXPAND_KEY = "button_carrier_sel_key";
     private static final String BUTTON_CARRIER_SETTINGS_KEY = "carrier_settings_key";
     private static final String BUTTON_CDMA_SYSTEM_SELECT_KEY = "cdma_system_select_key";
+    private static final String BUTTON_COLP_KEY = "connected_line_identification_key";
 
     static final int preferredNetworkMode = Phone.PREFERRED_NT_MODE;
 
@@ -117,6 +120,7 @@ public class MobileNetworkSettings extends PreferenceActivity
     private RestrictedSwitchPreference mButtonDataRoam;
     private SwitchPreference mButton4glte;
     private Preference mLteDataServicePref;
+    private SwitchPreference mButtonCOLP;
 
     private static final String iface = "rmnet0"; //TODO: this will go away
     private List<SubscriptionInfo> mActiveSubInfos;
@@ -251,6 +255,9 @@ public class MobileNetworkSettings extends PreferenceActivity
         } else if (preference == mButtonDataRoam) {
             // Do not disable the preference screen if the user clicks Data roaming.
             return true;
+        } else if (preference == mButtonCOLP) {
+            // Do not disable the preference screen if the user clicks COLP
+            return true;
         } else {
             // if the button is anything but the simple toggle preference,
             // we'll need to disable all preferences to reject all click
@@ -477,6 +484,9 @@ public class MobileNetworkSettings extends PreferenceActivity
 
         mLteDataServicePref = prefSet.findPreference(BUTTON_CDMA_LTE_DATA_SERVICE_KEY);
 
+        mButtonCOLP = (SwitchPreference)findPreference(BUTTON_COLP_KEY);
+        mButtonCOLP.setOnPreferenceChangeListener(this);
+
         // Initialize mActiveSubInfo
         int max = mSubscriptionManager.getActiveSubscriptionInfoCountMax();
         mActiveSubInfos = new ArrayList<SubscriptionInfo>(max);
@@ -560,6 +570,7 @@ public class MobileNetworkSettings extends PreferenceActivity
             prefSet.addPreference(mButtonPreferredNetworkMode);
             prefSet.addPreference(mButtonEnabledNetworks);
             prefSet.addPreference(mButton4glte);
+            prefSet.addPreference(mButtonCOLP);
         }
 
         int settingsNetworkMode = SubscriptionController.getInstance().getUserNwMode(phoneSubId);
@@ -726,6 +737,10 @@ public class MobileNetworkSettings extends PreferenceActivity
         if (ps != null) {
             ps.setEnabled(hasActiveSubscriptions);
         }
+
+        boolean COLPEnabled = CMSettings.System.getInt(getContentResolver(),
+                    CMSettings.System.CONNECTED_LINE_IDENTIFICATION, 1) != 0;
+        mButtonCOLP.setChecked(COLPEnabled);
     }
 
     @Override
@@ -878,6 +893,10 @@ public class MobileNetworkSettings extends PreferenceActivity
                 mPhone.setDataRoamingEnabled(false);
             }
             return true;
+        } else if (preference == mButtonCOLP) {
+            CMSettings.System.putInt(getContentResolver(),
+                    CMSettings.System.CONNECTED_LINE_IDENTIFICATION,
+                    mButtonCOLP.isChecked() ? 0 : 1);
         }
 
         updateBody();
-- 
2.11.0

